%\documentclass[9pt,preprint,nocopyrightspace]{sigplanconf}
%\documentclass[9pt,nocopyrightspace]{sig-alternate}
%\documentclass[pageno]{Submission-Info/jpaper}

%replace XXX with the submission number you are given from the ASPLOS submission site

%\newcommand{\asplossubmissionnumber}{236}
%\documentclass[letterpaper,twocolumn,10pt]{article}
%\usepackage{usenix}
% \documentclass[conference]{IEEEtran}
\documentclass[conference]{sig-alternate}
%\documentclass[pageno]{jpaper}
\usepackage[normalem]{ulem}
\usepackage{float}
\usepackage{url}
\usepackage{makeidx}
\usepackage{graphicx}
\usepackage{graphics}
\usepackage{multicol}
\usepackage{xspace}
\usepackage{chngpage}
%\usepackage{narrow}
%\usepackage{fullpage}
%\usepackage{subfigure}
\usepackage{subfig}
\usepackage{multirow}
\usepackage{rotating}
\usepackage{color}
%\usepackage{algorithmic2e}
\usepackage{algpseudocode}
\usepackage{algorithm}
\usepackage{savesym}
\usepackage{amsmath}
\usepackage{amssymb,latexsym}
\everymath{\displaystyle}
\savesymbol{iint} 
\usepackage{txfonts} 
\restoresymbol{TXF}{iint}
%\usepackage{mathptmx} % amsmath makes the paper longer
\usepackage{mathrsfs}
\usepackage{leading}
%\usepackage{algorithmic}
%\usepackage{algorithm}
%\usepackage{fullpage}
%\usepackage[font={small,bf},nooneline]{caption}
\usepackage{hyphenat}
\usepackage{leading}
\let\labelindent\relax
\usepackage{enumitem}
% \usepackage[natbib=true,backend=bibtex,firstinits=true,style=numeric-comp,sorting=nyt,defernumbers,maxnames=2,maxcitenames=2,doi=false,isbn=false,url=false]{biblatex}
\usepackage[natbib=true,backend=bibtex,firstinits=true,style=numeric-comp,sorting=nyt,defernumbers,maxnames=99,maxcitenames=99,doi=false,isbn=false,url=false]{biblatex}
\usepackage{balance}

% \newcommand{\asplossubmissionnumber}{XXX}


\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}
\usepackage{listings}
\lstset{ %
  backgroundcolor=\color{white},   % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}
  basicstyle=\scriptsize\ttfamily, % the size of the fonts that are used for the code
  breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
  breaklines=true,                 % sets automatic line breaking
  captionpos=b,                    % sets the caption-position to bottom
  commentstyle=\color{mygreen},    % comment style
  deletekeywords={...},            % if you want to delete keywords from the given language
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
  frame=leftline,                  % adds a frame around the code
  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
  keywordstyle=\color{blue},       % keyword style
  morekeywords={*,...},            % if you want to add more keywords to the set
  numbers=left,                    % where to put the line-numbers; possible values are (none, left, right)
  numbersep=5pt,                   % how far the line-numbers are from the code
  numberstyle=\tiny\color{mygray}, % the style that is used for the line-numbers
  rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
  showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
  showstringspaces=false,          % underline spaces within strings only
  showtabs=false,                  % show tabs within strings adding particular underscores
  stepnumber=1,                    % the step between two line-numbers. If it's 1, each line will be numbered
  stringstyle=\color{black},     % string literal style
  tabsize=1,                       % sets default tabsize to 2 spaces
  title=\lstname                   % show the filename of files included with \lstinputlisting; also try caption instead of title
}

\usepackage{pgfplots}
% options for pgfplots
\pgfplotsset{compat=1.8,compat/show suggested version=false}
\usetikzlibrary{calc,trees,arrows,patterns,plotmarks,shapes,snakes,er,3d,automata,backgrounds,topaths,decorations.pathmorphing,decorations.markings}
%\pgfplotsset{compat=newest}
\pgfplotsset{
   /pgfplots/bar  cycle  list/.style={/pgfplots/cycle  list={%
        {black,fill=black!30!white,mark=none},%
        {black,fill=red!30!white,mark=none},%
        {black,fill=green!30!white,mark=none},%
        {black,fill=yellow!30!white,mark=none},%
        {black,fill=brown!30!white,mark=none},%
     }
   },
}
% begin of externalization
\usetikzlibrary{external}
\tikzexternalize[prefix=out/]
\tikzexternalize
% don't externalize todonotes
%\makeatletter
%\renewcommand{\todo}[2][]{\tikzexternaldisable\@todo[#1]{#2}\tikzexternalenable}
%\makeatother
% end of externalization
\usetikzlibrary{patterns}
\usepgfplotslibrary{groupplots}
\pgfplotsset{
every axis label/.append style={font=\footnotesize},
tick label style={font=\footnotesize},
}
%\usepackage[normalem]{ulem}
%\setlength{\abovecaptionskip}{2pt plus 2pt minus 2pt}
%\setlist{noitemsep,topsep=0pt}

%\setlength{\itemsep}{0pt}
%\setlength{\topsep}{0pt}
%\setlength{\partopsep}{0pt}
%\setlength{\parsep}{1pt}
%\setlength{\parskip}{2pt}
%\setlength{\abovecaptionskip}{2pt plus 4pt minus 0pt}
%\setlength{\textfloatsep}{1pt}

\bibliography{../seec}
%\renewcommand{\bibfont}{\scriptsize}
%\setlength\bibitemsep{0pt}

%reduce space around equations
\makeatletter
\g@addto@macro\normalsize{%
  \setlength\abovedisplayskip{4pt plus 2pt minus 1pt}
  \setlength\belowdisplayskip{4pt plus 2pt minus 1pt}
  \setlength\abovedisplayshortskip{4pt plus 2pt minus 1pt}
  \setlength\belowdisplayshortskip{4pt plus 2pt minus 1pt}
}
\makeatother

\newif{\ifanonymous}
\anonymoustrue

%\newcommand{\comment}[1]{}
\newcommand{\cutout}[1]{}
\newcommand{\smallcaption}[1]{\caption[#1]{{\protect\small \protect\bf #1}}}
\newcommand{\dids}{{\sc dids}}

%\graphicspath{{figs/}}

% some useful shortcuts
\newcommand{\ie}{\textit{i.e., }}
\newcommand{\eg}{\textit{e.g., }}
\newcommand{\CC}{C\nolinebreak\hspace{-.05em}\raisebox{.5ex}{\tiny\bf +}\nolinebreak\hspace{-.10em}\raisebox{.5ex}{\tiny\bf +}}

% units for results
\newcommand{\us}{\,$\mu$s}
\newcommand{\ms}{\,ms}
\newcommand{\KB}{\,KB}
\newcommand{\MB}{\,MB}
\newcommand{\GB}{\,GB}
\newcommand{\MHz}{\,MHz}
\newcommand{\GHz}{\,GHz}

%\newcommand{\SYSTEM}{POET}
% \newcommand{\system}{poet}
% new latex commands:
%   Remove long section
\newcommand{\PUNT}[1]{}
\newcommand{\TABLETWO}[1]{}
%   Label work to be done
\definecolor{gray}{gray}{0.75}
\newcommand{\TODO}[1]{\textcolor{gray}{\textbf{\ [TODO:\ #1]\ }}}
\newcommand{\TR}[1]{#1}
%\newcommand{\TR}[1]{}
%\newcommand{\TODO}[1]{}
\newcommand{\FIX}[1] {\textcolor{red}{\textbf{\ [FIX:\ #1]\ }}}
%   Referencing various pieces of the document:
\newcommand{\figref}[1]{Figure~\ref{fig:#1}}
\newcommand{\figsref}[2]{Figures~\ref{fig:#1} and~\ref{fig:#2}}
\newcommand{\figrref}[2]{Figures~\ref{fig:#1}--\ref{fig:#2}}
\newcommand{\secref}[1]{Section~\ref{sec:#1}}
\newcommand{\secsref}[2]{Sections~\ref{sec:#1} and~\ref{sec:#2}}
\newcommand{\eqnref}[1]{Eqn.~\ref{eqn:#1}}
\newcommand{\eqnsref}[2]{Eqns.~\ref{eqn:#1} and~\ref{eqn:#2}}
\newcommand{\eqnrref}[2]{Eqns.~\ref{eqn:#1}--\ref{eqn:#2}}
\newcommand{\insref}[1]{Instruction~\ref{ins:#1}}
\newcommand{\tblref}[1]{Table~\ref{tbl:#1}}
\newcommand{\tblsref}[2]{Tables~\ref{tbl:#1} and~\ref{tbl:#2}}
\newcommand{\appref}[1]{Appendix~\ref{app:#1}}

\newcommand{\algoref}[1]{Algorithm~\ref{algo:#1}}

% Custom hyphenation rules
\hyphenation{Ang-strom}

%\DeclareMathOperator{\minimize}{minimize}
%\DeclareMathOperator{\st}{s.t.}
%\DeclareMathOperator*{\argmin}{argmin}
%\DeclareMathOperator*{\argmax}{argmax}
\newcommand{\argmin}{\arg\!\min}
\newcommand{\argmax}{\arg\!\max}
\newcommand{\minimize}{minimize}
\newcommand{\maximize}{maximize}
\newcommand{\optimize}{optimize}
\newcommand{\st}{s.t.}

\newcommand{\app}[1]{\mbox{\texttt{#1}}}
\newcommand{\interface}[1]{\textbf{#1}}
\newcommand{\function}[1]{\mbox{\texttt{#1}}}
\newcommand{\struct}[1]{\emph{#1}}
\newcommand{\variable}[1]{\emph{#1}}


%-------------------------------------------------------------------------
\begin{document}

\date{}

\title{Energy Efficiency in HPC with Machine Learning and Control Theory}

\numberofauthors{3} 
\author{
  \alignauthor
  Connor Imes \thanks{Part of this research was conducted while Connor Imes was a Computing Sciences Summer Student at Lawrence Berkeley National Laboratory.}\\ 
  \affaddr{University of Chicago} \\
  \email{ckimes@cs.uchicago.edu}
  \alignauthor
  Steven Hofmeyr \\ 
  \affaddr{Lawrence Berkeley National Laboratory} \\
  \email{shofmeyr@lbl.gov}
  \alignauthor
  Henry Hoffmann \\ 
  \affaddr{University of Chicago} \\
  \email{hankhoffmann@cs.uchicago.edu}
}

\maketitle 

% =============================================================================

\begin{abstract}
Performance and power management in High Performance Computing (HPC) has historically favored a race-to-idle approach in order to complete applications as quickly as possible, but this is not energy-efficient on modern systems.
As we move toward exascale and hardware over-provisioning, power management is becoming more critical than ever for HPC system administrators, opening the door for more balanced approaches to performance and power management.
We propose two projects to address balancing application performance and system power consumption in HPC \emph{during application runtime}, using closed loop feedback designs based on the Self-aware Computing Model to \emph{observe}, \emph{act}, and \emph{decide}.

\end{abstract}

\begin{figure}[t]
  \includegraphics[width=0.8\columnwidth]{../figures/seec.png}
  \captionof{figure}{The Self-aware Computing Model.}
  \label{fig:runtime-ee}
\end{figure}

% =============================================================================

\section{Machine Learning Classification for Energy Efficiency}

Dynamic voltage and frequency scaling (DVFS) is effective at saving energy by scaling back the processor during I/O or on code that is off the critical path \cite{RountreeAdagio,Jitter}.
DVFS is available in HPC job schedulers, though unfortunately today it is typically only configurable when a job is launched.

We propose a \interface{Machine Learning-based classifier} to predict the most energy-efficient DVFS frequencies \emph{during runtime} to maximize the work-to-energy ratio of an application running on a single node.
To train and drive our classifier, we capture low-level \emph{hardware counter metrics}, available through tools like \app{PAPI} and \app{PCM}\cite{PCMGit}.
\figref{runtime-ee} demonstrates the feedback design.

\begin{figure}[t]
  \input{img/scheme-ee.tex}
  \captionof{figure}{Machine Learning Classifier closed loop feedback control.}
  \label{fig:runtime-ee}
\end{figure}

At regular time intervals, the classifier predicts the most energy-efficient frequency to use based on measured application behavior, then applies the setting to the system.
% At regular time intervals, \eg every second, the classifier makes a new prediction.
As applications move through \emph{phases}, the controller adapts to the changing application behavior, \eg with the HiPMeraculous genome assembly application as shown in \figref{classifier-hipmer-ee}.

\begin{figure}[t]
  \input{img/hipmer-ee.tex}
  \captionof{figure}{Energy-efficient HiPMeraculous (Gradient Boosting classifier).}
  \label{fig:classifier-hipmer-ee}
\end{figure}

% =============================================================================

\section{MIMO Controller for Power Balancing}

In recent years, hardware has been taking more direct control of processor voltage and frequency, making fine-tuned software-management of DVFS obsolete.
Fine-grained \emph{power capping} is now the preferred mechanism for managing performance and power tradeoffs, evidenced by the introduction of power capping implementations like Intel Running Average Power Limit (RAPL) \cite{RAPL} and the move from Speed Step to Speed Shift.

Nodes in HPC clusters suffer \emph{non-uniformity} in performance and power consumption due to both manufacturing process variation and imbalance in application workloads.
We propose a generalized \interface{Multiple Input, Multiple Output (MIMO) Proportional Integral Derivative (PID) controller} to shift power allocations between nodes to eliminate tail idle times in job iterations, thus maximizing application throughput while respecting a global power cap.
Unlike heuristic approaches to power management, control theory provides \emph{formal guarantees} of \emph{convergence} as well as \emph{robustness} to application, system, and measurement noise \cite{Hellerstein2004a}.
These guarantees hold even for applications with different \emph{phases}.
\figref{runtime-nlpb} demonstrates the feedback control design.

\begin{figure}[t]
  \input{img/scheme-nlpb.tex}
  \captionof{figure}{MIMO PID controller closed loop feedback control.}
  \label{fig:runtime-nlpb}
\end{figure}

Given a cluster with $n$ nodes and global power cap $\Gamma$, the PID controller computes a new power signal vector $\vec{u}$ of size $n$ in each iteration $t$:
\begin{eqnarray}
\vec{u}(t) = \vec{u}(t-1) + K_I \cdot \vec{e}(t)
\end{eqnarray}
$K_I$ is the ratio of control change and $\vec{e}(t)$ are the node idle times, divided by their mean and normalized around $0$.
This formulation ensures that the entire global power cap is re-allocated in each iteration.
Formally:
\begin{eqnarray}
\sum_{i=1}^{n} e_i(t) = 0 \implies \sum_{i=1}^{n} u_i(t) = \sum_{i=1}^{n} u_i(t-1) = \Gamma
\end{eqnarray}
% $K_I$ is currently a fixed scalar value decided at initialization time, but we are exploring ways to predict it dynamically at runtime, \eg using a Kalman filter.

We simulate meeting a global power cap of 180 Watts on an artificially imbalanced quad-socket system ($\Gamma=180$, $n=4$) using a MPI+OpenMP application, with each MPI process bound to a socket.
We begin with evenly distributed power caps, \ie $u_i(0) = \frac{\Gamma}{n}$ for each socket $i$.
\figref{nlpb-sim} demonstrates the controller behavior over 10 time steps.
{
% NLPB_K=2.5 ./nlpb-simulator -n 4 -g 180 -p 40 -P 70 -c /local/nlpb-scripts/boggle/omp-only-balanced-3ghz-rapl.results -i boggle_imbalance.txt -N 10 -l nlpb.log
% boggle_imbalance:.txt
% 0.8
% 0.92
% 1.10
% 1.18
\begin{figure}[t]
  \input{img/nlpb.tex}
  \captionof{figure}{Simulation of changing node power caps between iterations.}
  \label{fig:nlpb-sim}
\end{figure}
The controller quickly re-balances power caps so that nodes finish their jobs with near-zero tail idle times, thus improving the total application performance.

% =============================================================================

\section{Acknowledgements}
The University of
  Chicago's effort on this project is funded by the U.S. Government
  under the DARPA BRASS program, by the Dept. of Energy under DOE
  DE-AC02-06CH11357, by the NSF under CCF 1439156, and by a DOE Early
  Career Award.

% =============================================================================

\balance
% \clearpage
\printbibliography

\end{document}
